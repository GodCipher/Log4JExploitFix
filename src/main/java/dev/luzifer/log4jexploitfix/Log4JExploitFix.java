package dev.luzifer.log4jexploitfix;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.ProtocolManager;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import org.bukkit.BanList;
import org.bukkit.Bukkit;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitRunnable;

import java.util.Objects;
import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public final class Log4JExploitFix extends JavaPlugin {
    
    private static final Pattern pattern = Pattern.compile("jndi:(?:ldap|rmi|iiop)");
    private final Logger logger = getLogger();
    public static Plugin plugin = null;
    
    private ProtocolManager protocolManager;
    
    @Override
    public void onLoad() {
        protocolManager = ProtocolLibrary.getProtocolManager();
    }
    
    @Override
    public void onEnable() {
        plugin = this;
        saveDefaultConfig();
        
        protocolManager.addPacketListener(new PacketAdapter(this, ListenerPriority.HIGHEST,
                PacketType.Play.Client.CHAT) {
    
            @Override
            public void onPacketReceiving(PacketEvent event) {
                
                if(event.getPacketType() == PacketType.Play.Client.CHAT) {
    
                    PacketContainer packetContainer = event.getPacket();
                    String message = packetContainer.getStrings().read(0);
                    
                    Matcher matcher = pattern.matcher(message.toLowerCase());
                    
                    if(matcher.find()) {
                        logger.severe(event.getPlayer().getName() + " just tried something malicious");
                        event.setCancelled(true);
                        if(getConfig().getBoolean("auto-ban")) {
                            if(!getConfig().getBoolean("use-command-instead-of-direct-ban")) {
                                Bukkit.getBanList(BanList.Type.NAME).addBan(event.getPlayer().getName(),
                                        getConfig().getString("ban-message"), null, null);

                                new BukkitRunnable() {
                                    @Override
                                    public void run() {
                                        event.getPlayer().kickPlayer(getConfig().getString("ban-message"));
                                    }
                                }.runTask(Log4JExploitFix.plugin);
                            }
                            else {
                                Bukkit.dispatchCommand(Bukkit.getConsoleSender(),
                                        Objects.requireNonNull(getConfig().getString("command-line")));
                            }
                        }
                    }
                
                }
            }
        });
    }
    
    @Override
    public void onDisable() {}
}
